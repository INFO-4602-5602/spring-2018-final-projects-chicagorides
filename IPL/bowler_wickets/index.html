<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .bar {
    fill: steelblue;
  }
</style>

<body>
  <script src="//d3js.org/d3.v4.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <link rel="stylesheet" type="text/css" href="style.css" />
  <div id="donut">

  </div>
  <div id="legend" class="legendSpace">
  </div>
  <script>

    var tooltip = d3.select("body").append("div")
      .attr("class", "tooltip1")
      .style("visibility", "hidden");
      var formatAsPercentage = d3.format(".2%");
    d3.csv('../../NEWDATA/bowlers.csv', function(error, data) {
      console.log(data);

      // set the dimensions and margins of the graph
      var margin = {
          top: 20,
          right: 20,
          bottom: 30,
          left: 40
        },
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      // set the ranges
      var y = d3.scaleBand()
        .range([height, 0])
        .padding(0.1);

      var x = d3.scaleLinear()
        .range([0, width]);

      // append the svg object to the body of the page
      // append a 'group' element to 'svg'
      // moves the 'group' element to the top left margin
      var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

      // format the data
      data.forEach(function(d) {
        d.runs = +d.runs;
      });

      // Scale the range of the data in the domains
      x.domain([0, d3.max(data, function(d) {
        return d.total;
      })])
      y.domain(data.map(function(d) {
        return d.bowler;
      }));
      //y.domain([0, d3.max(data, function(d) { return d.sales; })]);
      // var donut = donutChart()
      //   .width(960)
      //   .height(500)
      //   .transTime(750) // length of transitions in ms
      //   .cornerRadius(3) // sets how rounded the corners are on each slice
      //   .padAngle(0.015) // effectively dictates the gap between slices
      //   .variable('runs')
      //   .category('run_type');
      // append the rectangles for the bar chart
      svg.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        //.attr("x", function(d) { return x(d.sales); })
        .attr("width", function(d) {
          return x(d.total);
        })
        .attr("y", function(d) {
          return y(d.bowler);
        })
        .attr("height", y.bandwidth())
        .on("click", display)
        .on("mouseover", function(d,i) {
           d3.select(this)
             .attr("fill", "red");
       })
       .on("mouseout", function(d, i) {
         d3.select(this)
           .attr("fill", "blue");
       });

      function display(d) {
        console.log(d);
        var data_run = [{
            "wic_type": "bowled",
            "runs": +d["bowled"] / d["total"]
          },
          {
            "wic_type": "caught",
            "runs": +d["caught"] / d["total"]
          },
          {
            "wic_type": "hit wicket",
            "runs": +d["hit wicket"] / d["total"]
          },
          {
            "wic_type": "lbw",
            "runs": +d["lbw"] / d["total"]
          }
        ];
        // console.log(data_run[0]["runs"]);
        // d3.select("#donut").datum(data_run).call(donut);
        $("#donut").empty();
        dsDonutChart(data_run,d.bowler,d.total);
      }



      function dsDonutChart(donutChartData,player,total) {

        var width = 400,
          height = 400,
          outerRadius = Math.min(width, height) / 2,
          innerRadius = outerRadius * .999,
          // for animation
          innerRadiusFinal = outerRadius * .5,
          innerRadiusFinal3 = outerRadius * .45,

          // color = d3.scaleOrdinal().range(["#48A36D",  "#56AE7C",  "#64B98C", "#72C39B", "#80CEAA", "#80CCB3", "#7FC9BD", "#7FC7C6", "#7EC4CF", "#7FBBCF", "#7FB1CF", "#80A8CE", "#809ECE", "#8897CE", "#8F90CD", "#9788CD", "#9E81CC", "#AA81C5", "#B681BE", "#C280B7", "#CE80B0", "#D3779F", "#D76D8F", "#DC647E", "#E05A6D", "#E16167", "#E26962", "#E2705C", "#E37756", "#E38457", "#E39158", "#E29D58", "#E2AA59", "#E0B15B", "#DFB95C", "#DDC05E", "#DBC75F", "#E3CF6D", "#EAD67C", "#F2DE8A"]);
          color = d3.scaleOrdinal()
            .domain(["0","1","2","3","4","5","6"])
            .range(["red","green","yellow","pink","blue","#581845","#581845"]);
          ; //builtin range of colors

        // color = d3.scaleOrdinal().range(["#07E712","#FF5733","#E72E07","#581845","#24EECD","#0FF09A","#F00FF0","#9D919D","#5141F0","#41A0F0", "#13EF10","#EFB210","#EF8A10","#EF10AB","#0C856A","#34660A","#0A4666","#E2ABB5","#E70964","#967FA9","#9BA97F"]);


        // var donutChartData = chosenDonutData(school_year, genderType);





        console.log("Player is "+ player);
        var vis = d3.select("#donut")
          .append("svg:svg") //create the SVG element inside the <body>
          .data(donutChartData) //associate our data with the document
          .attr("width", width) //set the width and height of our visualization (these will be attributes of the <svg> tag
          .attr("height", height)
          .append("svg:g") //make a group to hold our pie chart
          .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")") //move the center of the pie chart from 0, 0 to radius, radius
        ;

        $("#legend").empty();
        var legend_svg = d3.select("#legend")
          .append("svg") //create the SVG element inside the <body>
          //associate our data with the document
          .attr("width", width) //set the width and height of our visualization (these will be attributes of the <svg> tag
          .attr("height", height)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var legend = legend_svg.selectAll(".wictype")
          .data(donutChartData)
          .enter().append("g")
          .attr("class", "wictype");
        console.log("here");
        var legendSpace = 200 / 5;

        legend.append("rect")
          .attr("width", 20)
          .attr("height", 20)
          .attr("x", 10)
          .attr("y", function(d, i) {
            return (legendSpace) + i * (legendSpace) - 8;
          })
          .attr("fill", function(d, i) {
            select_color = color(d.wic_type);
            console.log("Color is "+select_color);
            return color(d.wic_type); // If array key "visible" = true then color rect, if not then make it grey
          })
          .attr("class", "legend-box");

        legend.append("text")
          .attr("x", 35)
          .attr("y", function(d, i) {
            return (legendSpace) + i * (legendSpace) + 6;
          }) // (return (11.25/2 =) 5.625) + i * (5.625)
          .text(function(d, i) {
            console.log(d.wic_type);
            return d.wic_type;
          });


        var arc = d3.arc() //this will create <path> elements for us using arc data
          .outerRadius(outerRadius).innerRadius(innerRadius);

        // for animation
        var arcFinal = d3.arc().innerRadius(innerRadiusFinal).outerRadius(outerRadius);
        var arcFinal3 = d3.arc().innerRadius(innerRadiusFinal3).outerRadius(outerRadius);

        var pie = d3.pie() //this will create arc data for us given a list of values
          .value(function(d) {
            return d.runs;
          }); //we must tell it out to access the value of each element in our data array

        var arcs = vis.selectAll("g.slice") //this selects all <g> elements with class slice (there aren't any yet)
          .data(pie(donutChartData)) //associate the generated pie data (an array of arcs, each having startAngle, endAngle and value properties)
          .enter() //this will create <g> elements for every "extra" data element that should be associated with a selection. The result is creating a <g> for every object in the data array
          .append("svg:g") //create a group to hold each slice (we will have a <path> and a <text> element associated with each slice)
          .attr("class", "slice") //allow us to style things in the slices (like text)
          .on("mouseover", mouseover)
          .on("mouseout", mouseout)
        // .on("click", up)
        ;

        arcs.append("svg:path")
          .attr("fill", function(d, i) {
            return color(i);
          }) //set the color for each slice to be chosen from the color function defined above
          .attr("d", arc) //this creates the actual SVG path using the associated data (pie) with the arc drawing function
          // .append("svg:title") //mouseover title showing the figures
          //  .text(function(d) {return d.data.race + ": " + d.data.measure;})
          .on("mouseover", function(d) {
            return tooltip.html(d.data.wic_type + " : " + formatAsPercentage((d.data.runs).toFixed(3)))
              .style("visibility", "visible")
              .style("top", (event.pageY - 17) + "px").style("left", (event.pageX + 25) + "px");
          })
          .on("mouseout", function() {
            return tooltip.style("visibility", "hidden");
          })

        d3.selectAll("g.slice").selectAll("path").transition()
          .duration(750)
          .delay(10)
          .attr("d", arcFinal)
          .attr("data-legend", function(d) {
            return d.wic_type
          });

        // Add a label to the larger arcs, translated to the arc centroid and rotated.
        // source: http://bl.ocks.org/1305337#index.html
        arcs.filter(function(d) {
            return d.endAngle - d.startAngle > .2;
          })
          .append("svg:text")
          .attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .attr("transform", function(d) {
            return "translate(" + arcFinal.centroid(d) + ")rotate(" + angle(d) + ")";
          });

        // Computes the label angle of an arc, converting from radians to degrees.
        function angle(d) {
          var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
          return a > 90 ? a - 180 : a;
        }

        // Pie chart title
        vis.append("svg:text")
          .attr("dy", ".35em")
          .attr("text-anchor", "middle")
          .attr("font-weight", "bold")
          .style("font-size", "16px")
          .text(player)
          .attr("class", "title");

        vis.append("svg:text")
          .attr("dy", "1.75em")
          .attr("text-anchor", "middle")
          .attr("font-weight", "bold")
          .style("font-size", "16px")
          .text(total+" wickets")
          .attr("class", "title");

        function mouseover() {
          d3.select(this).select("path").transition()
            .duration(400)
            .attr("d", arcFinal3);
        }

        function mouseout() {
          d3.select(this).select("path").transition()
            .duration(400)
            .attr("d", arcFinal);
        }



      }



      // add the x Axis
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

      // add the y Axis
      svg.append("g")
        .call(d3.axisLeft(y));
    });
  </script>
</body>
